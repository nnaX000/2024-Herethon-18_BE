<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/reset.css' %}">
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/board_detail.css' %}">
    <title>ProReflect</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
    <header id="header">
        <a href="{% url 'main' %}" id="header-logo">ProReflect</a>
        <nav id="header-nav">
            <a href="{% url 'board_list' %}">공유용 게시판</a>
            <a href="{% if user.is_authenticated %}{% url 'grow_1' %}{% else %}{% url 'login' %}{% endif %}">성장관찰</a>
            <a href="{% if user.is_authenticated %}{% url 'mypage_share' %}{% else %}{% url 'login' %}{% endif %}">마이페이지</a>
        </nav>
    </header>
    <main>
        <a href="{% url 'main' %}">
            <img src="{% static 'img/back-button.svg' %}" alt="뒤로가기 아이콘" class="back-btn-icon">
        </a>
        <div class="board-detail-container">
            <h1 id="board-detail-title">{{ post.title }}</h1>
            <h3 id="board-detail-username">{{ post.user.username }}</h3>
            <div class="board-detail-top">
                <div id="board-detail-friends">
                    <h4>@other_user</h4>
                    <h4>@other_user_with_a_long_name</h4>
                    <h4>@other_user1</h4>
                    <!-- 참여한 친구들 표시 -->
                </div>
                <div id="board-detail-btns">
                    {% if request.user == post.user %}
                        <!-- <button id="board-detail-update">수정하기</button>
                        <button id="board-detail-delete">삭제하기</button> -->
                        <a href="{% url 'update' post.id %}">수정</a>
                        <a href="{% url 'delete' post.id %}">삭제</a>
                    {% endif %}
                </div>
            </div>
            <div id="board-detail-info-container">
                <div id="board-detail1"> <!-- 개발 기간이랑 참여 인원 -->
                    <div class="board-detail-info">{{ post.get_development_period_display }}</div>
                    <div class="board-detail-info">{{ post.get_participants_display }}</div>
                </div>
                <div id="board-detail2"> <!-- 사용 언어 -->
                    <div class="board-detail-info">{{ post.get_language_display }}</div>
                </div>
            </div>
            <div class="board-detail-bottom">
                {% if post.file %}
                    <img src="{{ post.file.url }}" alt="게시글 이미지" id="board-detail-img">
                {% else %}
                    <img src="{% static 'img/default_project_image.png' %}" alt="게시글 이미지" id="board-detail-img">
                {% endif %}
                <p id="board-detail-content">{{ post.content }}</p>
                <div class="board-detail-bottom-box">
                    <div class="board-detail-btn-container">
                        <button class="board-detail-btn" id="like-btn" data-post-id="{{ post.id }}">
                            <img src="{% static 'img/heart.svg' %}" alt="좋아요 버튼 아이콘">
                            <span class="likes-count">{{ post.likes.count }}</span>
                        </button>
                        <button class="board-detail-btn" id="dislike-btn" data-post-id="{{ post.id }}">
                            <img src="{% static 'img/water-drop.svg' %}" alt="아쉬워요 버튼 아이콘">
                            <span class="dislikes-count">{{ post.dislikes.count }}</span>
                        </button>
                    </div>
                    <h4>(최종수정 {{ post.updated_at|date:"Y.m.d" }}) {{ post.created_at|date:"Y.m.d" }}</h4>
                </div>
            </div>            
        </div>
        <div class="board-detail-comment-container"> <!-- 댓글 -->
            <!-- 댓글 로직은 필요에 따라 추가 -->
            <div class="board-detail-comment">
                <div class="board-detail-comment-info">
                    <div class="board-detail-comment-username">Username</div>
                    <div class="board-detail-comment-date">YYYY.MM.DD</div>
                </div>
                <p class="board-detail-comment-content">
                    This is a comment about a certain post. ser can write no matter what is concerned with the post. Users could talk about their impressions, good points, some possible improvements about the project, etc. They could also give a question to the writer with this comment function.
                </p>
            </div>
            <div class="board-detail-comment">
                <div class="board-detail-comment-info">
                    <div class="board-detail-comment-username">Username</div>
                    <div class="board-detail-comment-date">YYYY.MM.DD</div>
                </div>
                <p class="board-detail-comment-content">
                    This is a comment about a certain post. ser can write no matter what is concerned with the post. Users could talk about their impressions, good points, some possible improvements about the project, etc. They could also give a question to the writer with this comment function.
                </p>
            </div>
            <div class="board-detail-comment">
                <div class="board-detail-comment-info">
                    <div class="board-detail-comment-username">Username</div>
                    <div class="board-detail-comment-date">YYYY.MM.DD</div>
                </div>
                <p class="board-detail-comment-content">
                    This is a comment about a certain post. ser can write no matter what is concerned with the post. Users could talk about their impressions, good points, some possible improvements about the project, etc. They could also give a question to the writer with this comment function.
                </p>
            </div>
        </div>
    </main>
    <script>
        $(document).ready(function() {
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = jQuery.trim(cookies[i]);
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrftoken = getCookie('csrftoken');
    
            function csrfSafeMethod(method) {
                return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
            }
            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });
    
            $('#like-btn').click(function() {
                var postId = $(this).data('post-id');
                $.ajax({
                    url: '/like_post/' + postId + '/',
                    method: 'POST',
                    contentType: 'application/json',  // Set content type to JSON
                    data: JSON.stringify({}),  // Send empty JSON object
                    success: function(response) {
                        $('.likes-count').text(response.likes);
                        $('#like-btn img').attr('src', response.liked ? '{% static "img/heart-clicked.svg" %}' : '{% static "img/heart.svg" %}');
                    },
                    error: function(xhr, status, error) {
                        console.error("Error: " + error);
                        console.error("Response: " + xhr.responseText);
                    }
                });
            });

            $('#dislike-btn').click(function() {
                var postId = $(this).data('post-id');
                $.ajax({
                    url: '/dislike_post/' + postId + '/',
                    method: 'POST',
                    contentType: 'application/json',  // Ensure the content-type is set to application/json
                    data: JSON.stringify({}),  // Sending an empty object as data
                    success: function(response) {
                        $('.dislikes-count').text(response.dislikes);
                        $('#dislike-btn img').attr('src', response.disliked ? '{% static "img/water-drop-clicked.svg" %}' : '{% static "img/water-drop.svg" %}');
                    },
                    error: function(xhr, status, error) {
                        console.error("Error: " + error);
                        console.error("Response: " + xhr.responseText);
                    }
                });
            });
        });
    </script>
</body>
</html>